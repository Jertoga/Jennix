// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-storage.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyDsb7m4EijaU3NNxwoos8y6egI29nfbChk",
    authDomain: "jennix-777e1.firebaseapp.com",
    projectId: "jennix-777e1",
    storageBucket: "jennix-777e1.appspot.com",
    messagingSenderId: "673075142639",
    appId: "1:673075142639:web:ea93e3ae1b244463ca201a",
    measurementId: "G-HKJ85NVGF4"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// DOM Elements
const uploadForm = document.getElementById('uploadForm');
const fileInput = document.getElementById('fileInput');
const fileNameDisplay = document.getElementById('fileNameDisplay');
const imagePreview = document.getElementById('imagePreview');
const videoPreview = document.getElementById('videoPreview');
const captionText = document.getElementById('captionText');
const uploadBtn = document.getElementById('uploadBtn');
const galleryGrid = document.getElementById('galleryGrid');
const loadingSpinner = document.getElementById('loadingSpinner');
const noContentMessage = document.getElementById('noContentMessage');
const logoutBtn = document.getElementById('logoutBtn');
const authButton = document.getElementById('authButton');

// Global state
let currentUser = null;

// Detecteer mobiele apparaten
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth <= 600;

// Mobiele aanpassingen
function adjustLayoutForMobile() {
    if (isMobile) {
        captionText.style.minHeight = '60px';
        document.body.style.height = window.innerHeight + 'px';
        window.scrollTo(0, 1);
    }
}

document.addEventListener('DOMContentLoaded', adjustLayoutForMobile);
window.addEventListener('resize', adjustLayoutForMobile);
window.addEventListener('orientationchange', adjustLayoutForMobile);

// Auth state observer
onAuthStateChanged(auth, async (user) => {
    if (user) {
        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            currentUser = {
                uid: user.uid,
                email: user.email,
                username: userDoc.exists() ? userDoc.data().username : "User"
            };
            
            captionText.disabled = false;
            uploadBtn.disabled = false;
            uploadBtn.setAttribute('aria-disabled', 'false');
            logoutBtn.style.display = "inline-block";
            authButton.classList.add('hidden');
        } catch (error) {
            console.error("Error getting user data:", error);
            alert("Error loading user data: " + error.message);
        }
    } else {
        currentUser = null;
        captionText.disabled = true;
        uploadBtn.disabled = true;
        uploadBtn.setAttribute('aria-disabled', 'true');
        logoutBtn.style.display = "none";
        authButton.classList.remove('hidden');
    }
    loadGalleryContent(); // Laad gallery ongeacht auth status
});

// File input change handler
fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    
    if (file) {
        // Valideer bestandstype
        if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
            alert("Please select an image or video file.");
            fileInput.value = '';
            return;
        }
        
        // Valideer bestandsgrootte (10MB limiet)
        if (file.size > 10 * 1024 * 1024) {
            alert("File size exceeds 10MB limit.");
            fileInput.value = '';
            return;
        }
        
        fileNameDisplay.textContent = file.name;
        
        // Reset previews
        imagePreview.classList.remove('show');
        videoPreview.classList.remove('show');
        
        // Toon preview
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.add('show');
            };
            reader.readAsDataURL(file);
        } else if (file.type.startsWith('video/')) {
            const url = URL.createObjectURL(file);
            videoPreview.src = url;
            videoPreview.classList.add('show');
        }
        
        if (currentUser) {
            captionText.disabled = false;
            uploadBtn.disabled = false;
            uploadBtn.setAttribute('aria-disabled', 'false');
        }
    } else {
        fileNameDisplay.textContent = "No file selected";
        imagePreview.classList.remove('show');
        videoPreview.classList.remove('show');
        uploadBtn.disabled = true;
        uploadBtn.setAttribute('aria-disabled', 'true');
    }
});

// Upload handler
uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!currentUser) {
        alert("Please sign in to upload media.");
        return;
    }
    
    const file = fileInput.files[0];
    if (!file) {
        alert("Please select a file to upload.");
        return;
    }
    
    const hadFocus = document.activeElement === captionText;
    loadingSpinner.style.display = 'block';
    uploadBtn.disabled = true;
    uploadBtn.setAttribute('aria-disabled', 'true');
    
    try {
        const storageRef = ref(storage, `gallery/${currentUser.uid}/${Date.now()}_${file.name}`);
        const uploadTask = uploadBytesResumable(storageRef, file);
        
        uploadTask.on('state_changed',
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload is ' + progress + '% done');
            },
            (error) => {
                console.error("Upload failed:", error);
                alert("Upload failed: " + error.message);
                loadingSpinner.style.display = 'none';
                uploadBtn.disabled = false;
                uploadBtn.setAttribute('aria-disabled', 'false');
            },
            async () => {
                try {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    
                    await addDoc(collection(db, "gallery"), {
                        userId: currentUser.uid,
                        username: currentUser.username,
                        caption: captionText.value.trim(),
                        fileURL: downloadURL,
                        fileType: file.type.startsWith('image/') ? 'image' : 'video',
                        fileName: file.name,
                        timestamp: new Date(),
                        likes: 0,
                        likedBy: [],
                        views: 0,
                        comments: 0
                    });
                    
                    // Reset formulier
                    uploadForm.reset();
                    fileNameDisplay.textContent = "No file selected";
                    imagePreview.classList.remove('show');
                    videoPreview.classList.remove('show');
                    captionText.disabled = !currentUser;
                    uploadBtn.disabled = true;
                    uploadBtn.setAttribute('aria-disabled', 'true');
                    loadingSpinner.style.display = 'none';
                    
                    // Herstel focus
                    if (hadFocus) {
                        captionText.focus();
                        setTimeout(() => captionText.focus(), 50);
                    }
                    
                    alert("Media uploaded successfully!");
                } catch (error) {
                    console.error("Error saving media:", error);
                    alert("Error saving media: " + error.message);
                    loadingSpinner.style.display = 'none';
                    uploadBtn.disabled = false;
                    uploadBtn.setAttribute('aria-disabled', 'false');
                }
            }
        );
    } catch (error) {
        console.error("Upload error:", error);
        alert("Upload error: " + error.message);
        loadingSpinner.style.display = 'none';
        uploadBtn.disabled = false;
        uploadBtn.setAttribute('aria-disabled', 'false');
    }
});

// Placeholder voor loadGalleryContent (bestaande functie, blijft ongewijzigd)
async function loadGalleryContent() {
    // Bestaande logica voor het laden van gallery-items
    // Voeg hier je bestaande code toe
}
